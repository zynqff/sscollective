{% extends "base.html" %}

{% block content %}
<div class="mb-8 p-6 bg-white rounded-xl shadow-lg border border-gray-200">
    <input type="search" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞–≤—Ç–æ—Ä—É –∏–ª–∏ —Ç–µ–∫—Å—Ç—É..."
        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-sky-500 focus:border-sky-500 transition duration-150 text-lg">

    {% if current_user %}
    <div class="flex flex-nowrap overflow-x-auto gap-3 justify-center mt-4 p-2 -m-2">
        <button data-filter="unfiltered" id="tab-unfiltered"
            class="tab flex-shrink-0 px-4 py-2 rounded-lg font-semibold transition-colors duration-150 {% if not show_all_tab %}hidden{% endif %}">–í—Å–µ
            (<span id="count-all">0</span>)</button>
        <button data-filter="unread" id="tab-unread"
            class="tab flex-shrink-0 px-4 py-2 rounded-lg font-semibold transition-colors duration-150 active">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
            (<span id="count-unread">0</span>)</button>
        <button data-filter="read" id="tab-read"
            class="tab flex-shrink-0 px-4 py-2 rounded-lg font-semibold transition-colors duration-150">–ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
            (<span id="count-read">0</span>)</button>
    </div>
    {% else %}
    <div class="flex flex-nowrap overflow-x-auto gap-3 justify-center mt-4 p-2 -m-2">
        <button data-filter="unfiltered" id="tab-unfiltered-public"
            class="tab flex-shrink-0 px-4 py-2 rounded-lg font-semibold transition-colors duration-150 active">–í—Å–µ
            (<span id="count-all">0</span>)</button>
    </div>
    {% endif %}

    <div id="sort-buttons-container" class="flex flex-wrap gap-2 justify-center mt-4 pt-4 border-t border-gray-100">
        <span class="font-medium text-gray-700 mr-2 self-center">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</span>
        <button data-sort="title" data-order="asc"
            class="sort-btn active px-4 py-2 rounded-lg font-semibold transition-colors duration-150 text-base">–ù–∞–∑–≤–∞–Ω–∏—é
            <svg data-sort-icon="title"
                class="sort-arrow-icon w-4 h-4 inline ml-1 align-text-top transform transition-transform"
                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
            </svg>
        </button>
        <button data-sort="author" data-order="asc"
            class="sort-btn px-4 py-2 rounded-lg font-semibold transition-colors duration-150 text-base">–ê–≤—Ç–æ—Ä—É
            <svg data-sort-icon="author"
                class="sort-arrow-icon w-4 h-4 inline ml-1 align-text-top transform transition-transform"
                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
            </svg>
        </button>
        <button data-sort="length" data-order="asc"
            class="sort-btn px-4 py-2 rounded-lg font-semibold transition-colors duration-150 text-base">–î–ª–∏–Ω–µ
            <svg data-sort-icon="length"
                class="sort-arrow-icon w-4 h-4 inline ml-1 align-text-top transform transition-transform"
                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
            </svg>
        </button>
    </div>
</div>

<div id="poems-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

<p id="no-results-message" class="text-center text-xl text-gray-500 mt-10 hidden">
    –ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É —Å—Ç–∏—Ö–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. üòî
</p>
{% endblock %}

{% block modals %}
<div id="poem-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 sm:p-8 transform scale-95 transition-transform duration-300"
        id="modal-content">
        <h2 id="modal-title" class="text-3xl font-bold mb-2 text-gray-900 break-words"></h2>
        <p id="modal-author" class="text-lg text-gray-600 mb-4 italic"></p>
        <div class="h-px bg-gray-200 mb-6"></div>
        <pre id="modal-text" class="poem mb-6 text-base text-gray-800"></pre>

        {% if current_user %}
        <div class="flex flex-wrap justify-between items-center pt-4 border-t border-gray-100 space-y-3 sm:space-y-0">
            <div class="flex space-x-3">
                <div id="read-button-wrapper" class="hidden">
                    <button id="toggle-read-btn"
                        class="flex items-center space-x-2 px-4 py-2 rounded-full font-semibold transition-colors duration-200 shadow-md text-sm">
                        <svg id="read-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span id="read-status-text"></span>
                    </button>
                </div>
                <div id="pin-button-wrapper" class="hidden">
                    <button id="toggle-pin-btn"
                        class="flex items-center space-x-2 px-4 py-2 rounded-full font-semibold transition-colors duration-200 shadow-md text-sm">
                        <svg id="pin-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.5 4.5l-4.5 4.5l-4.5-4.5L15 10zM12 21V3" />
                        </svg>
                        <span id="pin-status-text"></span>
                    </button>
                </div>
                <div id="ai-button-wrapper">
                    <button id="ai-btn"
                        class="flex items-center space-x-2 px-4 py-2 rounded-full font-semibold transition-colors duration-200 shadow-md text-sm bg-purple-500 text-white hover:bg-purple-600">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        <span>AI</span>
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <button id="close-modal-btn"
            class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 transition-colors duration-150">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>
</div>

<div id="ai-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col p-6 sm:p-8" id="ai-modal-content">
        <div id="ai-key-entry" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">–î–æ—Å—Ç—É–ø –∫ AI-—Ñ—É–Ω–∫—Ü–∏–∏</h2>
            <p class="text-gray-600 mb-4">–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏. –í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
            <form id="ai-key-form">
                <input type="text" id="ai-key-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á..." class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4">
                <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 rounded-lg">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á</button>
            </form>
        </div>

        <div id="ai-chat-interface" class="hidden h-full flex flex-col">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">–ß–∞—Ç —Å AI</h2>
            <div id="ai-chat-history" class="flex-grow bg-gray-100 rounded-lg p-4 overflow-y-auto mb-4">
                <!-- Chat messages will be here -->
            </div>
            <form id="ai-chat-form">
                <div class="flex">
                    <input type="text" id="ai-chat-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –æ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–∏..." class="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg">
                    <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold px-6 rounded-r-lg">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
        
        <button id="close-ai-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ FastAPI
    const isAuthenticated = {{ 'true' if current_user else 'false' }};
    let readPoemsTitles = new Set({{ read_poems | tojson | safe if read_poems else '[]' }});
    let pinnedPoemTitle = "{{ pinned_title if pinned_title else '' }}";
    const isAdmin = {{ 'true' if is_admin else 'false' }};

    let currentFilter = 'unread'; 
    let currentSort = { type: 'title', order: 'asc' };
    let poems = {{ poems | tojson | safe }};

    const searchInput = document.getElementById('search-input');
    const poemGrid = document.getElementById('poem-grid');
    const modal = document.getElementById('poem-modal');
    const aiModal = document.getElementById('ai-modal');

    // --- –§–£–ù–ö–¶–ò–Ø –ß–ê–¢–ê –° AI (Markdown) ---
    async function handleAiChatSubmit(e) {
        e.preventDefault();
        const input = document.getElementById('ai-chat-input');
        const prompt = input.value.trim();
        if (!prompt) return;

        const chatContainer = document.getElementById('ai-chat-messages');

        // –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userDiv = document.createElement('div');
        userDiv.className = "mb-4 text-right";
        userDiv.innerHTML = `
            <div class="inline-block bg-sky-500 text-white px-4 py-2 rounded-lg max-w-[85%] shadow-sm text-left">
                ${prompt}
            </div>
        `;
        chatContainer.appendChild(userDiv);
        input.value = '';

        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const loadingDiv = document.createElement('div');
        loadingDiv.className = "mb-4 text-left";
        loadingDiv.innerHTML = `
            <div class="inline-block bg-gray-200 text-gray-600 px-4 py-2 rounded-lg animate-pulse">
                –ù–µ–π—Ä–æ—Å–µ—Ç—å –¥—É–º–∞–µ—Ç...
            </div>
        `;
        chatContainer.appendChild(loadingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        try {
            // –í —Ç–≤–æ–µ–º —Ä–æ—É—Ç–µ—Ä–µ ai.py –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è query-–ø–∞—Ä–∞–º–µ—Ç—Ä prompt
            const response = await fetch(`/ai/chat?prompt=${encodeURIComponent(prompt)}`, {
                method: 'POST'
            });
            const data = await response.json();
            loadingDiv.remove();

            const aiDiv = document.createElement('div');
            aiDiv.className = "mb-4 text-left";
            
            // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º Markdown –≤ –∫—Ä–∞—Å–∏–≤—ã–π HTML
            const rawContent = data.response || data.detail || "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞";
            const renderedContent = marked.parse(rawContent);

            aiDiv.innerHTML = `
                <div class="ai-response-content inline-block bg-white border border-gray-200 text-gray-800 px-4 py-2 rounded-lg max-w-[95%] shadow-md">
                    ${renderedContent}
                </div>
            `;
            
            chatContainer.appendChild(aiDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

        } catch (error) {
            if (loadingDiv) loadingDiv.remove();
            showNotification("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º", "error");
        }
    }

    // --- –õ–û–ì–ò–ö–ê –§–ò–õ–¨–¢–†–ê–¶–ò–ò –ò –ö–ê–†–¢–û–ß–ï–ö ---
    function filterAndRender() {
        const query = searchInput.value.toLowerCase();
        let filtered = poems.filter(p => 
            p.title.toLowerCase().includes(query) || 
            p.author.toLowerCase().includes(query) || 
            p.text.toLowerCase().includes(query)
        );

        if (isAuthenticated) {
            if (currentFilter === 'read') {
                filtered = filtered.filter(p => readPoemsTitles.has(p.title));
            } else if (currentFilter === 'unread') {
                filtered = filtered.filter(p => !readPoemsTitles.has(p.title));
            }
        }

        filtered.sort((a, b) => {
            let valA = a[currentSort.type];
            let valB = b[currentSort.type];
            if (currentSort.order === 'desc') [valA, valB] = [valB, valA];
            return valA.toString().localeCompare(valB.toString(), undefined, {numeric: true});
        });

        renderPoems(filtered);
        updateCounts();
    }

    function renderPoems(list) {
        poemGrid.innerHTML = '';
        list.forEach(poem => {
            const isRead = readPoemsTitles.has(poem.title);
            const isPinned = pinnedPoemTitle === poem.title;
            
            const card = document.createElement('div');
            card.className = `poem-card bg-white p-6 rounded-xl shadow-md border-t-4 transition-all hover:shadow-lg cursor-pointer flex flex-col justify-between ${isRead ? 'border-green-400 opacity-75' : 'border-sky-400'}`;
            card.innerHTML = `
                <div>
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xl font-bold text-gray-800">${poem.title}</h3>
                        ${isPinned ? '<span class="text-yellow-500 text-xl">üìå</span>' : ''}
                    </div>
                    <p class="text-gray-600 italic mb-4">${poem.author}</p>
                </div>
                <div class="text-sm text-gray-400 flex justify-between items-center mt-4">
                    <span>${poem.line_count} —Å—Ç—Ä–æ–∫</span>
                    ${isRead ? '<span class="text-green-600 font-semibold">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ</span>' : ''}
                </div>
            `;
            card.onclick = () => openModal(poem);
            poemGrid.appendChild(card);
        });
    }

    function updateCounts() {
        if (!isAuthenticated) return;
        const countAll = document.getElementById('count-all');
        const countRead = document.getElementById('count-read');
        const countUnread = document.getElementById('count-unread');
        
        if(countAll) countAll.textContent = poems.length;
        if(countRead) countRead.textContent = readPoemsTitles.size;
        if(countUnread) countUnread.textContent = poems.length - readPoemsTitles.size;
    }

    // --- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ---
    function openModal(poem) {
        document.getElementById('modal-title').textContent = poem.title;
        document.getElementById('modal-author').textContent = poem.author;
        document.getElementById('modal-text').textContent = poem.text;
        
        if (isAuthenticated) {
            const readBtn = document.getElementById('toggle-read-btn');
            const pinBtn = document.getElementById('toggle-pin-btn');
            
            readBtn.textContent = readPoemsTitles.has(poem.title) ? "–ù–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ" : "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ";
            pinBtn.textContent = pinnedPoemTitle === poem.title ? "–û—Ç–∫—Ä–µ–ø–∏—Ç—å" : "–ó–∞–∫—Ä–µ–ø–∏—Ç—å";
            
            readBtn.onclick = () => toggleRead(poem.title);
            pinBtn.onclick = () => togglePin(poem.title);
        }
        modal.classList.add('open');
    }

    function closeModal() { modal.classList.remove('open'); }
    function openAiModal() { aiModal.classList.add('open'); }
    function closeAiModal() { aiModal.classList.remove('open'); }

    // --- API –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï ---
    async function toggleRead(title) {
        const resp = await fetch('/toggle_read', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title})
        });
        const data = await resp.json();
        if (data.success) {
            if (data.action === 'marked') readPoemsTitles.add(title);
            else readPoemsTitles.delete(title);
            filterAndRender();
            closeModal();
        }
    }

    async function togglePin(title) {
        const resp = await fetch('/toggle_pin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title})
        });
        const data = await resp.json();
        if (data.success) {
            pinnedPoemTitle = data.action === 'pinned' ? title : '';
            filterAndRender();
            closeModal();
        }
    }

    async function handleAiKeySubmit(e) {
        e.preventDefault();
        const key = document.getElementById('ai-key-input').value;
        const resp = await fetch('/ai/verify_key', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({key})
        });
        if (resp.ok) {
            location.reload();
        } else {
            showNotification("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á", "error");
        }
    }

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ---
    window.onload = () => {
        filterAndRender();
        
        if(searchInput) searchInput.addEventListener('input', filterAndRender);
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active', 'bg-sky-500', 'text-white'));
                tab.classList.add('active', 'bg-sky-500', 'text-white');
                currentFilter = tab.dataset.filter;
                filterAndRender();
            };
        });

        const chatForm = document.getElementById('ai-chat-form');
        if(chatForm) chatForm.addEventListener('submit', handleAiChatSubmit);
        
        const keyForm = document.getElementById('ai-key-form');
        if(keyForm) keyForm.addEventListener('submit', handleAiKeySubmit);
        
        document.getElementById('close-ai-modal-btn')?.addEventListener('click', closeAiModal);
    };
</script>
{% endblock %}

                
                                                
