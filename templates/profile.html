<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>–ü—Ä–æ—Ñ–∏–ª—å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: #374151;
        }

        /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ */
        #settings-forms-container {
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            max-height: 0;
        }

        #settings-forms-container.open {
            max-height: 1000px;
            /* –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ */
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen p-4 sm:p-8 flex items-center justify-center">

    <div class="w-full max-w-xl bg-white rounded-xl shadow-2xl p-6 sm:p-10 border border-gray-200">

        <div class="flex justify-between items-start mb-6">
            <h1 class="text-3xl font-extrabold text-gray-800">
                –ü—Ä–∏–≤–µ—Ç, {{ current_user.username }}! üëã
            </h1>
        </div>
        
        {% if success %}
        <div class="mb-4 p-3 text-sm rounded-lg shadow-sm bg-green-100 text-green-700">
            {{ success }}
        </div>
        {% endif %}
        {% if error %}
        <div class="mb-4 p-3 text-sm rounded-lg shadow-sm bg-red-100 text-red-700">
            {{ error }}
        </div>
        {% endif %}


        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">–õ–∏—á–Ω—ã–µ –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <form method="POST" action="{{ request.url_for('profile_post') }}">

            <div class="mb-4">
                <label for="new_password" class="block text-sm font-medium text-gray-700 mb-1">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞)</label>
                <input type="password" id="new_password" name="new_password"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-sky-500 focus:border-sky-500 transition duration-150"
                    placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å">
            </div>

            <div class="mb-6 p-4 border border-gray-100 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">–í–∏–¥–∏–º–æ—Å—Ç—å –í–∫–ª–∞–¥–∫–∏</h3>
                <div class="flex items-center mb-4">
                    <input id="show_all_tab" name="show_all_tab" type="checkbox" {{ 'checked' if show_all_tab else '' }}
                        class="h-5 w-5 text-sky-600 border-gray-300 rounded focus:ring-sky-500" value="on">
                    <label for="show_all_tab" class="ml-3 text-sm font-medium text-gray-700">
                        –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–∫–ª–∞–¥–∫—É "–í—Å–µ" (–í—Å–µ —Å—Ç–∏—Ö–∏)
                    </label>
                </div>
            </div>

            <p class="text-sm font-semibold text-gray-700 mb-2">
                –õ–∏—á–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏
            </p>
            <p class="text-sm text-gray-500 mb-2">
                –≠—Ç–∏ –∑–∞–º–µ—Ç–∫–∏ –≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –≤–∞–º.
            </p>

            <div class="mb-6">
                <textarea name="user_data" rows="8"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-sky-500 focus:border-sky-500 transition duration-150"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–∏—á–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...">{{ user_data }}</textarea>
            </div>

            <button type="submit"
                class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 rounded-lg transition-colors duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
        </form>

        <div class="mt-8 pt-4 border-t border-gray-100 flex justify-between items-center">
            <a href="{{ request.url_for('read_root') }}"
                class="text-sky-600 hover:text-sky-800 text-sm font-medium transition-colors">
                ‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é
            </a>
            <a href="{{ request.url_for('logout') }}"
                class="text-red-600 hover:text-red-800 text-sm font-medium transition-colors">
                –í—ã–π—Ç–∏
            </a>
        </div>
    </div>

    {% if current_user.is_admin %}
    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 sm:p-10 border border-gray-200 mt-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ AI –ö–ª—é—á–∞–º–∏</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <h3 class="text-xl font-semibold text-gray-700 mb-4">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ù–æ–≤—ã–π –ö–ª—é—á</h3>
                <form id="generate-key-form">
                    <div class="mb-4">
                        <label for="expires_in_hours" class="block text-sm font-medium text-gray-700 mb-1">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–≤ —á–∞—Å–∞—Ö, 0 = –±–µ—Å—Å—Ä–æ—á–Ω–æ)</label>
                        <input type="number" id="expires_in_hours" name="expires_in_hours" value="0" min="0"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div class="mb-4">
                        <label for="daily_limit" class="block text-sm font-medium text-gray-700 mb-1">–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (0 = –±–µ–∑–ª–∏–º–∏—Ç–Ω–æ)</label>
                        <input type="number" id="daily_limit" name="daily_limit" value="0" min="0"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <button type="submit"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition-colors duration-200 shadow-md">
                        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </form>
                <div id="new-key-display" class="mt-4 p-3 bg-gray-100 rounded-lg text-sm text-gray-800 hidden">
                    <strong>–ù–æ–≤—ã–π –∫–ª—é—á:</strong> <code id="new-key-value" class="break-all"></code>
                </div>
            </div>
            
            <div>
                <h3 class="text-xl font-semibold text-gray-700 mb-4">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ö–ª—é—á–∏</h3>
                <div id="keys-table-container" class="max-h-96 overflow-y-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="text-left text-sm text-gray-600">
                                <th class="p-2">–ö–ª—é—á</th>
                                <th class="p-2">–°—Ç–∞—Ç—É—Å</th>
                                <th class="p-2">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="keys-table-body" class="divide-y divide-gray-200">
                            <!-- Rows will be injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</body>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (document.getElementById('generate-key-form')) {
            const form = document.getElementById('generate-key-form');
            const newKeyDisplay = document.getElementById('new-key-display');
            const newKeyValue = document.getElementById('new-key-value');

            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                const expiresInHours = document.getElementById('expires_in_hours').value;
                const dailyLimit = document.getElementById('daily_limit').value;

                try {
                    const response = await fetch(`/ai/generate_key?expires_in_hours=${expiresInHours}&daily_limit=${dailyLimit}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });

                    if (response.ok) {
                        const data = await response.json();
                        newKeyValue.textContent = data.key;
                        newKeyDisplay.classList.remove('hidden');
                        loadKeys(); // Refresh the table
                    } else {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á.');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞:', error);
                }
            });

            async function loadKeys() {
                try {
                    const response = await fetch('/ai/get_keys');
                    if (response.ok) {
                        const keys = await response.json();
                        const tbody = document.getElementById('keys-table-body');
                        tbody.innerHTML = '';
                        keys.forEach(key => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="p-2 text-xs break-all"><code>${key.key}</code></td>
                                <td class="p-2 text-sm">${key.is_active ? '<span class="text-green-600">–ê–∫—Ç–∏–≤–µ–Ω</span>' : '<span class="text-red-600">–û—Ç–∫–ª—é—á–µ–Ω</span>'}</td>
                                <td class="p-2">
                                    <button data-key="${key.key}" class="disable-key-btn text-red-500 hover:text-red-700 text-sm" ${!key.is_active ? 'disabled' : ''}>
                                        –û—Ç–∫–ª—é—á–∏—Ç—å
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–ª—é—á–µ–π:', error);
                }
            }

            document.getElementById('keys-table-body').addEventListener('click', async function(e) {
                if (e.target && e.target.classList.contains('disable-key-btn')) {
                    const key = e.target.dataset.key;
                    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á?')) {
                        try {
                            const response = await fetch(`/ai/disable_key/${key}`, { method: 'POST' });
                            if (response.ok) {
                                loadKeys();
                            } else {
                                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª—é—á–∏—Ç—å –∫–ª—é—á.');
                            }
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∫–ª—é—á–∞:', error);
                        }
                    }
                }
            });
            
            loadKeys();
        }
    });
</script>

</html>